<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Greenport Express â€” Balloon Pop</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --bg1:#e5e7eb; --bg2:#d1d5db; --ground:#7fbf73;
      --rail:#374151; --tie:#7c4a1b;
      --train-blue:#2563eb; --train-yellow:#fbbf24; --train-dark:#111827;
      --rotary-gold:#f59e0b; --ui:#0f172a; --ui2:#475569; --accent:#10b981;
      --brand-red:#ef4444;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial}
    body{background:linear-gradient(var(--bg1),var(--bg2))}
    .wrap{max-width:1100px;margin:0 auto;min-height:100dvh;display:grid;grid-template-rows:auto 1fr auto;gap:10px;padding:12px}
    header,footer{
      background:#fff;border:1px solid #e5e7eb;border-radius:14px;padding:10px 14px;
      box-shadow:0 8px 24px rgba(15,23,42,.08);display:flex;align-items:center;justify-content:space-between;gap:12px
    }
    h1{margin:0;font-size:20px;letter-spacing:.3px}
    .hud{display:flex;gap:14px;flex-wrap:wrap;color:var(--ui2);font-weight:700}
    .btn{border:1px solid #94a3b8;background:#f8fafc;border-radius:10px;padding:8px 12px;font-weight:700;cursor:pointer}
    .btn.primary{background:var(--accent);color:#fff;border-color:#059669}
    #game{display:block;width:100%;aspect-ratio:16/9;background:var(--bg1);border-radius:16px;border:1px solid #dbeafe;box-shadow:0 10px 30px rgba(2,6,23,.08);touch-action:none}
    .help{font-size:14px;color:var(--ui2)}
    .kbd{border:1px solid #cbd5e1;background:#f9fafb;border-bottom-width:3px;border-radius:6px;padding:2px 6px;font-size:12px;font-weight:700}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>ðŸš‚ Greenport Express â€” Balloon Pop</h1>
      <div class="hud">
        <span>Score: <span id="score">0</span></span>
        <span>Level: <span id="level">1</span></span>
        <span>Time: <span id="time">60</span>s</span>
        <button id="whistleBtn" class="btn">Whistle</button>
        <button id="pauseBtn" class="btn">Pause</button>
        <button id="muteBtn" class="btn">Mute</button>
        <button id="restartBtn" class="btn primary">Restart</button>
      </div>
    </header>

    <canvas id="game" width="1280" height="720" aria-label="Greenport Express game canvas"></canvas>

    <footer>
      <div class="help">
        Splash screen: Tap/press any key to start. Aim with mouse/touch and <span class="kbd">Click/Tap</span> or <span class="kbd">Space</span> to shoot. <span class="kbd">W</span> whistles.
      </div>
      <div class="help">Place audio next to this file: <code>balloon-pop.wav</code>, <code>jackpot.wav</code>, <code>level-up.wav</code>, <code>long-high-whistle.wav</code>, <code>double-whistle.wav</code>, <code>double-whistle-2.wav</code>, <code>whistle-short.wav</code>. Optional: <code>train.png</code>.</div>
    </footer>
  </div>

  <!-- Preload sounds -->
  <audio id="popAudio" src="balloon-pop.wav" preload="auto"></audio>
  <audio id="jackpotAudio" src="jackpot.wav" preload="auto"></audio>
  <audio id="levelupAudio" src="level-up.wav" preload="auto"></audio>
  <audio id="wh1" src="long-high-whistle.wav" preload="auto"></audio>
  <audio id="wh2" src="double-whistle.wav" preload="auto"></audio>
  <audio id="wh3" src="double-whistle-2.wav" preload="auto"></audio>
  <audio id="wh4" src="whistle-short.wav" preload="auto"></audio>

  <script>
    // ====== Config: replaceable train image ======
    const TRAIN_IMAGE_SRC = 'train.png'; // put a PNG with transparent bg next to index.html
    const TRAIN_IMAGE_SCALE = 0.38;      // fraction of canvas width for the train image

    // ===== Canvas bootstrap =====
    const canvas = document.getElementById('game');
    const ctx = canvas.getContext('2d');
    function fitCanvas(){
      const r = canvas.getBoundingClientRect();
      const s = devicePixelRatio || 1;
      canvas.width = Math.max(640, Math.floor(r.width*s));
      canvas.height = Math.floor(canvas.width/16*9);
    }
    new ResizeObserver(fitCanvas).observe(canvas); fitCanvas();

    // ===== UI =====
    const uiScore   = document.getElementById('score');
    const uiLevel   = document.getElementById('level');
    const uiTime    = document.getElementById('time');
    const whistleBtn= document.getElementById('whistleBtn');
    const pauseBtn  = document.getElementById('pauseBtn');
    const muteBtn   = document.getElementById('muteBtn');
    const restartBtn= document.getElementById('restartBtn');

    // ===== Game state =====
    let running = false, muted = false, audioUnlocked = false;
    let lastFrame = performance.now();
    let gs;

    function resetGame(toSplash=true){
      gs = {
        phase: toSplash ? 'splash' : 'playing', // 'splash' | 'playing' | 'milestone'
        score:0, level:1, timeLeft:60, lastTick:performance.now(),
        pointer:{x:canvas.width*0.4, y:canvas.height*0.55},
        bullets:[], balloons:[], particles:[],
        pops:[], floatTexts:[],
        whistlePuffs:[], // NEW: smokestack puffs
        milestone500Shown:false,
        bonus:false, bonusTimer:0,
        offsets:{clouds:0, far:0, mid:0, track:0},
        goldenChance:0.06, rotaryChance:0.045,
        shootCooldown:0
      };
      uiScore.textContent=0; uiLevel.textContent=1; uiTime.textContent=60;
      running = !toSplash;
      pauseBtn.textContent = 'Pause';
    }
    resetGame(true);

    // ===== Audio =====
    const popEl = document.getElementById('popAudio');
    const jackpotEl = document.getElementById('jackpotAudio');
    const levelupEl = document.getElementById('levelupAudio');
    const whistleEls = [
      document.getElementById('wh1'),
      document.getElementById('wh2'),
      document.getElementById('wh3'),
      document.getElementById('wh4'),
    ];
    let ac;
    function getAC(){ if(!ac){ try{ ac=new (window.AudioContext||window.webkitAudioContext)(); }catch(e){ ac=null; } } return ac; }

    async function unlockAudio(){
      if(audioUnlocked) return;
      const els=[popEl,jackpotEl,levelupEl,...whistleEls];
      for(const el of els){
        try{ await el.play(); el.pause(); el.currentTime=0; }catch(e){}
      }
      audioUnlocked = true;
      if(getAC() && ac.state === 'suspended'){ try { await ac.resume(); } catch(e){} }
    }

    function shootBeep(){
      if(muted||!getAC()) return;
      const t=ac.currentTime, o=ac.createOscillator(), g=ac.createGain();
      o.type='square'; o.frequency.value=260;
      g.gain.setValueAtTime(0,t); g.gain.linearRampToValueAtTime(0.05,t+0.02); g.gain.exponentialRampToValueAtTime(0.0001,t+0.09);
      o.connect(g); g.connect(ac.destination); o.start(t); o.stop(t+0.1);
    }
    function synthPop(){
      if(muted||!getAC()) return;
      const t=ac.currentTime, o=ac.createOscillator(), g=ac.createGain();
      o.type='triangle'; o.frequency.setValueAtTime(900,t);
      o.frequency.exponentialRampToValueAtTime(300, t+0.08);
      g.gain.setValueAtTime(0,t); g.gain.linearRampToValueAtTime(0.06,t+0.01); g.gain.exponentialRampToValueAtTime(0.0001,t+0.1);
      o.connect(g); g.connect(ac.destination); o.start(t); o.stop(t+0.12);
    }
    function playAudioClone(el, rate=1, fallback){
      if(muted) return;
      try{
        const s=el.cloneNode(); s.playbackRate = rate; s.currentTime=0;
        const p=s.play();
        if(p && typeof p.then==='function'){ p.catch(()=>fallback && fallback()); }
      }catch(e){ if(fallback) fallback(); }
    }
    const popSound     = (rate=1)=>playAudioClone(popEl, rate, synthPop);
    const jackpotSound = ()=>playAudioClone(jackpotEl, 1);
    const levelupSound = ()=>playAudioClone(levelupEl, 1);

    // ===== WHISTLE + puffs =====
    let lastWhistleAt = 0;
    function synthWhistle(){
      if(muted||!getAC()) return;
      const t=ac.currentTime;
      const o=ac.createOscillator(); const g=ac.createGain();
      o.type='sine'; o.frequency.setValueAtTime(700,t);
      o.frequency.linearRampToValueAtTime(1200, t+0.5);
      const lfo=ac.createOscillator(); const lfoGain=ac.createGain();
      lfo.frequency.value=6; lfoGain.gain.value=20; lfo.connect(lfoGain); lfoGain.connect(o.frequency);
      g.gain.setValueAtTime(0,t); g.gain.linearRampToValueAtTime(0.12,t+0.03); g.gain.exponentialRampToValueAtTime(0.0001,t+0.8);
      o.connect(g); g.connect(ac.destination);
      o.start(t); lfo.start(t); o.stop(t+0.8); lfo.stop(t+0.8);
    }
    async function playWhistle(){
      const now=performance.now(); if(now-lastWhistleAt<1000) return; lastWhistleAt=now;
      await unlockAudio();
      const pick = whistleEls[Math.floor(Math.random()*whistleEls.length)];
      playAudioClone(pick, 1, synthWhistle);
      spawnWhistlePuffs(); // NEW: visual puff
    }

    function spawnWhistlePuffs(){
      const {stackX, stackTopY} = smokestackPos();
      const baseR = canvas.height*0.02;
      for(let i=0;i<4;i++){
        gs.whistlePuffs.push({
          x: stackX + (Math.random()-0.5)*baseR*0.8,
          y: stackTopY + (Math.random()-0.5)*baseR*0.6,
          r: baseR*(0.8 + Math.random()*0.6),
          vx: (Math.random()-0.5)*canvas.width*0.02,
          vy: -canvas.height*(0.10 + Math.random()*0.06),
          life:0, max: 1.2 + Math.random()*0.4
        });
      }
    }

    // ===== Input =====
    function toCoords(e){ const r=canvas.getBoundingClientRect(); const s=canvas.width/r.width; return {x:(e.clientX-r.left)*s,y:(e.clientY-r.top)*s}; }
    canvas.addEventListener('pointermove',e=>{ gs.pointer=toCoords(e); });
    canvas.addEventListener('pointerdown',async e=>{
      gs.pointer=toCoords(e);
      if(gs.phase==='splash'){ await startGame(); return; }
      if(gs.phase==='milestone'){ resumeAfterMilestone(); return; }
      shoot();
    });
    window.addEventListener('keydown',async e=>{
      if(gs.phase==='splash'){ await startGame(); return; }
      if(gs.phase==='milestone'){ resumeAfterMilestone(); return; }
      if(e.code==='Space'){ shoot(); }
      if(e.key.toLowerCase()==='p'){ togglePause(); }
      if(e.key.toLowerCase()==='m'){ toggleMute(); }
      if(e.key.toLowerCase()==='w'){ playWhistle(); }
    });

    pauseBtn.onclick=()=>{ if(gs.phase!=='playing') return; running=!running; pauseBtn.textContent=running?'Pause':'Resume'; if(running) lastFrame=performance.now(); };
    muteBtn.onclick=()=>{ muted=!muted; muteBtn.textContent=muted?'Unmute':'Mute'; };
    restartBtn.onclick=()=>resetGame(true);
    whistleBtn.onclick=playWhistle;

    async function startGame(){
      await unlockAudio();
      gs.phase='playing'; running=true; lastFrame=performance.now();
      playWhistle(); // fun toot on start
    }
    function resumeAfterMilestone(){ gs.phase='playing'; running=true; lastFrame=performance.now(); }
    function togglePause(){ if(gs.phase!=='playing') return; running=!running; pauseBtn.textContent=running?'Pause':'Resume'; if(running) lastFrame=performance.now(); }
    function toggleMute(){ muted=!muted; muteBtn.textContent=muted?'Unmute':'Mute'; }

    // ===== Helpers =====
    function trainPos(){
      const w=canvas.width,h=canvas.height, baseY=h*0.74;
      const x=w*0.18 + Math.sin(performance.now()/700)*w*0.006;
      const cannonX=x + w*0.14; const cannonY=baseY - h*0.11;
      return {x, y:baseY, cannonX, cannonY};
    }
    function smokestackPos(){
      // Based on built-in train geometry; good enough for image too (stack near front/top)
      const {x,y} = trainPos(); const w=canvas.width, h=canvas.height;
      const stackBaseX = x + w*0.205, stackTopX = x + w*0.22;
      const stackTopY = y - h*0.20; // top opening
      return {stackX: stackTopX, stackBaseX, stackTopY};
    }
    function shoot(){
      const now=performance.now(); if(now<gs.shootCooldown) return;
      gs.shootCooldown = now + 110;
      const t=trainPos(), ang=Math.atan2(gs.pointer.y - t.cannonY, gs.pointer.x - t.cannonX);
      const sp=canvas.height*0.63;
      gs.bullets.push({x:t.cannonX, y:t.cannonY, vx:Math.cos(ang)*sp, vy:Math.sin(ang)*sp, life:0});
      shootBeep();
    }
    function burst(x,y,color,count=16){
      for(let i=0;i<count;i++){
        const a=Math.random()*Math.PI*2, s=(Math.random()*0.5+0.5)*(canvas.height*0.25);
        gs.particles.push({x,y,vx:Math.cos(a)*s,vy:Math.sin(a)*s,life:0,max:0.5+Math.random()*0.5,color});
      }
    }
    function addPopAnim(x,y,color){ gs.pops.push({x,y,color,life:0,max:0.25,startR:canvas.height*0.01,endR:canvas.height*0.06,spikes:12}); }
    function addFloatText(x,y,text,color){ gs.floatTexts.push({x,y,text,color,life:0,max:0.9,vy:-canvas.height*0.15}); }

    // ===== Balloons =====
    function spawnBalloon(){
      const h=canvas.height,w=canvas.width;
      const isRotary = Math.random() < gs.rotaryChance;
      const golden = !isRotary && Math.random() < gs.goldenChance;
      const r = isRotary ? h*0.04 : golden ? h*0.035 : h*(0.022 + Math.random()*0.02);
      const x = Math.random()*(w*0.85 - w*0.1) + w*0.1;
      const vy = -(h*0.06 + Math.random()*h*0.06 + gs.level*0.003*h);
      const hue = golden ? 45 : Math.floor(Math.random()*360);
      gs.balloons.push({x, y:h + r + Math.random()*h*0.2, vy, r, hue, golden, rotary:isRotary, wob:Math.random()*Math.PI*2});
    }

    // ===== Update =====
    function update(dt){
      const now=performance.now();
      if(now-gs.lastTick>=1000 && running){
        gs.lastTick=now; gs.timeLeft=Math.max(0, gs.timeLeft-1); uiTime.textContent=gs.timeLeft;
        if(gs.timeLeft===0){
          if(gs.level>=5){ running=false; } else{
            gs.level++; uiLevel.textContent=gs.level; gs.timeLeft=60; uiTime.textContent=60;
            levelupSound();
            if(gs.level%3===0){ gs.bonus=true; gs.rotaryChance=0.12; gs.bonusTimer=12; }
          }
        }
      }
      if(gs.bonus){ gs.bonusTimer-=dt; if(gs.bonusTimer<=0){ gs.bonus=false; gs.rotaryChance=0.045; } }

      // parallax
      const base = canvas.width*0.12*dt;
      gs.offsets.clouds=(gs.offsets.clouds+base*0.15)%canvas.width;
      gs.offsets.far=(gs.offsets.far+base*0.35)%canvas.width;
      gs.offsets.mid=(gs.offsets.mid+base*0.6)%canvas.width;
      gs.offsets.track=(gs.offsets.track+base*0.9)%canvas.width;

      // spawn balloons
      const rate = gs.bonus ? 0.028 : (0.012 + gs.level*0.0018);
      if(Math.random() < rate*(dt*60)) spawnBalloon();

      // bullets
      gs.bullets.forEach(b=>{ b.x+=b.vx*dt; b.y+=b.vy*dt; b.life+=dt; });
      gs.bullets = gs.bullets.filter(b=> b.life<1.5 && b.x>-60 && b.x<canvas.width+60 && b.y>-60 && b.y<canvas.height+60);

      // balloons
      gs.balloons.forEach(b=>{ b.wob+=dt*3; b.x += Math.sin(b.wob)*(canvas.width*0.02*dt); b.y += b.vy*dt; });
      gs.balloons = gs.balloons.filter(b=> b.y + b.r > -40);

      // collisions + scoring
      for(let i=gs.balloons.length-1;i>=0;i--){
        const bl=gs.balloons[i];
        for(let j=gs.bullets.length-1;j>=0;j--){
          const bu=gs.bullets[j]; const dx=bl.x-bu.x, dy=bl.y-bu.y;
          if(dx*dx+dy*dy < bl.r*bl.r){
            gs.bullets.splice(j,1); gs.balloons.splice(i,1);
            const pts = bl.rotary ? 50 : 10;
            gs.score += pts; uiScore.textContent=gs.score;
            if(bl.rotary) jackpotSound(); else popSound(1);
            const col = bl.rotary ? `hsl(40 95% 50%)` : `hsl(${bl.hue} 85% 60%)`;
            burst(bl.x, bl.y, col, bl.rotary?30:16);
            addPopAnim(bl.x, bl.y, col);
            addFloatText(bl.x, bl.y - bl.r*0.2, `+${pts}`, col);

            // Milestone popup at 500
            if(!
