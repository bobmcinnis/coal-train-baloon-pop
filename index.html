<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Greenport Express â€” Balloon Pop</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --bg1:#e5e7eb; --bg2:#d1d5db; --ground:#7fbf73;
      --rail:#374151; --tie:#7c4a1b;
      --train-blue:#2563eb; --train-yellow:#fbbf24; --train-dark:#111827;
      --rotary-gold:#f59e0b; --ui:#0f172a; --ui2:#475569; --accent:#10b981;
      --brand-red:#ef4444;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial}
    body{background:linear-gradient(var(--bg1),var(--bg2))}
    .wrap{max-width:1100px;margin:0 auto;min-height:100dvh;display:grid;grid-template-rows:auto 1fr auto;gap:10px;padding:12px}
    header,footer{
      background:#fff;border:1px solid #e5e7eb;border-radius:14px;padding:10px 14px;
      box-shadow:0 8px 24px rgba(15,23,42,.08);display:flex;align-items:center;justify-content:space-between;gap:12px
    }
    h1{margin:0;font-size:20px;letter-spacing:.3px}
    .hud{display:flex;gap:14px;flex-wrap:wrap;color:var(--ui2);font-weight:700}
    .btn{border:1px solid #94a3b8;background:#f8fafc;border-radius:10px;padding:8px 12px;font-weight:700;cursor:pointer}
    .btn.primary{background:var(--accent);color:#fff;border-color:#059669}
    #game{display:block;width:100%;aspect-ratio:16/9;background:var(--bg1);border-radius:16px;border:1px solid #dbeafe;box-shadow:0 10px 30px rgba(2,6,23,.08);touch-action:none}
    .help{font-size:14px;color:var(--ui2)}
    .kbd{border:1px solid #cbd5e1;background:#f9fafb;border-bottom-width:3px;border-radius:6px;padding:2px 6px;font-size:12px;font-weight:700}
    /* splash button */
    .startbtn{
      border:0;border-radius:14px;padding:14px 22px;background:var(--brand-red);color:#fff;font-weight:800;cursor:pointer;
      box-shadow:0 8px 20px rgba(239,68,68,.35); font-size:18px;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>ðŸš‚ Greenport Express â€” Balloon Pop</h1>
      <div class="hud">
        <span>Score: <span id="score">0</span></span>
        <span>Level: <span id="level">1</span></span>
        <span>Time: <span id="time">60</span>s</span>
        <button id="pauseBtn" class="btn">Pause</button>
        <button id="muteBtn" class="btn">Mute</button>
        <button id="restartBtn" class="btn primary">Restart</button>
      </div>
    </header>

    <canvas id="game" width="1280" height="720" aria-label="Greenport Express game canvas"></canvas>

    <footer>
      <div class="help">
        Aim with mouse/touch and <span class="kbd">Click/Tap</span> to shoot. <span class="kbd">Space</span> also shoots.
        Watch for the <strong>Rotary gear balloon</strong> â€” itâ€™s worth big points!
      </div>
      <div class="help">Single-file, embeddable. Place <code>balloon-pop.wav</code> next to this file.</div>
    </footer>
  </div>

  <!-- Preload pop sound via HTMLAudio for better iOS/Safari behavior -->
  <audio id="popAudio" src="balloon-pop.wav" preload="auto"></audio>

  <script>
    // ===== Canvas bootstrap =====
    const canvas = document.getElementById('game');
    const ctx = canvas.getContext('2d');
    function fitCanvas(){
      const r = canvas.getBoundingClientRect();
      const s = devicePixelRatio || 1;
      canvas.width = Math.max(640, Math.floor(r.width*s));
      canvas.height = Math.floor(canvas.width/16*9);
    }
    new ResizeObserver(fitCanvas).observe(canvas); fitCanvas();

    // ===== UI =====
    const uiScore = document.getElementById('score');
    const uiLevel = document.getElementById('level');
    const uiTime  = document.getElementById('time');
    const pauseBtn = document.getElementById('pauseBtn');
    const muteBtn  = document.getElementById('muteBtn');
    const restartBtn = document.getElementById('restartBtn');

    // ===== Game state =====
    let running = false, muted = false, audioUnlocked = false;
    let lastFrame = performance.now();
    let gs;

    function resetGame(toSplash=true){
      gs = {
        phase: toSplash ? 'splash' : 'playing', // 'splash' | 'playing'
        score:0, level:1, timeLeft:60, lastTick:performance.now(),
        pointer:{x:canvas.width*0.4, y:canvas.height*0.55},
        bullets:[], balloons:[], particles:[],
        bonus:false, bonusTimer:0,
        offsets:{clouds:0, far:0, mid:0, track:0},
        goldenChance:0.06, rotaryChance:0.045,
        shootCooldown:0
      };
      uiScore.textContent=0; uiLevel.textContent=1; uiTime.textContent=60;
      running = !toSplash;
      pauseBtn.textContent = running ? 'Pause' : 'Pause';
    }
    resetGame(true);

    // ===== Audio =====
    const popEl = document.getElementById('popAudio');
    let ac;
    function getAC(){ if(!ac){ try{ ac=new (window.AudioContext||window.webkitAudioContext)(); }catch(e){ ac=null; } } return ac; }

    async function unlockAudio(){
      if(audioUnlocked) return;
      try { await popEl.play(); popEl.pause(); popEl.currentTime = 0; audioUnlocked = true; }
      catch(e){ audioUnlocked = false; } // still fine; we'll fall back if needed
      if(getAC() && ac.state === 'suspended'){
        try { await ac.resume(); } catch(e){}
      }
    }

    function shootBeep(){
      if(muted||!getAC()) return;
      const t=ac.currentTime, o=ac.createOscillator(), g=ac.createGain();
      o.type='square'; o.frequency.value=260;
      g.gain.setValueAtTime(0,t); g.gain.linearRampToValueAtTime(0.05,t+0.02); g.gain.exponentialRampToValueAtTime(0.0001,t+0.09);
      o.connect(g); g.connect(ac.destination); o.start(t); o.stop(t+0.1);
    }
    function synthPop(){
      if(muted||!getAC()) return;
      const t=ac.currentTime, o=ac.createOscillator(), g=ac.createGain();
      o.type='triangle'; o.frequency.setValueAtTime(900,t);
      o.frequency.exponentialRampToValueAtTime(300, t+0.08);
      g.gain.setValueAtTime(0,t); g.gain.linearRampToValueAtTime(0.06,t+0.01); g.gain.exponentialRampToValueAtTime(0.0001,t+0.1);
      o.connect(g); g.connect(ac.destination); o.start(t); o.stop(t+0.12);
    }
    function popSound(pitch=1){
      if(muted) return;
      // Try the audio element first; if blocked or error, fall back to synth.
      try {
        const s = popEl.cloneNode(); s.playbackRate = pitch; s.currentTime = 0;
        const p = s.play();
        if(p && typeof p.then === 'function'){ p.catch(()=>synthPop()); }
      } catch(e){ synthPop(); }
    }
    function levelChime(){
      if(muted||!getAC()) return; const t=ac.currentTime;
      [640,800,960].forEach((f,i)=>{ const o=ac.createOscillator(), g=ac.createGain();
        o.type='triangle'; o.frequency.value=f; const t0=t+i*0.09;
        g.gain.setValueAtTime(0,t0); g.gain.linearRampToValueAtTime(0.05,t0+0.03); g.gain.exponentialRampToValueAtTime(0.0001,t0+0.1);
        o.connect(g); g.connect(ac.destination); o.start(t0); o.stop(t0+0.12);
      });
    }

    // ===== Input =====
    function toCoords(e){ const r=canvas.getBoundingClientRect(); const s=canvas.width/r.width; return {x:(e.clientX-r.left)*s,y:(e.clientY-r.top)*s}; }
    canvas.addEventListener('pointermove',e=>{ gs.pointer=toCoords(e); });
    canvas.addEventListener('pointerdown',async e=>{
      gs.pointer=toCoords(e);
      if(gs.phase==='splash'){ await startGame(); return; }
      shoot();
    });
    window.addEventListener('keydown',async e=>{
      if(gs.phase==='splash'){ await startGame(); return; }
      if(e.code==='Space'){ shoot(); }
      if(e.key.toLowerCase()==='p'){ togglePause(); }
      if(e.key.toLowerCase()==='m'){ toggleMute(); }
    });

    pauseBtn.onclick=togglePause;
    muteBtn.onclick=toggleMute;
    restartBtn.onclick=()=>resetGame(true);

    async function startGame(){
      await unlockAudio();
      gs.phase='playing'; running=true; lastFrame=performance.now();
    }
    function togglePause(){ if(gs.phase!=='playing') return; running=!running; pauseBtn.textContent=running?'Pause':'Resume'; if(running) lastFrame=performance.now(); }
    function toggleMute(){ muted=!muted; muteBtn.textContent=muted?'Unmute':'Mute'; }

    // ===== Helpers =====
    function trainPos(){
      const w=canvas.width,h=canvas.height, baseY=h*0.74;
      const x=w*0.18 + Math.sin(performance.now()/700)*w*0.006;
      const cannonX=x + w*0.14; const cannonY=baseY - h*0.11;
      return {x, y:baseY, cannonX, cannonY};
    }
    function shoot(){
      const now=performance.now(); if(now<gs.shootCooldown) return;
      gs.shootCooldown = now + 110;
      const t=trainPos(), ang=Math.atan2(gs.pointer.y - t.cannonY, gs.pointer.x - t.cannonX);
      const sp=canvas.height*0.63;
      gs.bullets.push({x:t.cannonX, y:t.cannonY, vx:Math.cos(ang)*sp, vy:Math.sin(ang)*sp, life:0});
      shootBeep();
    }
    function burst(x,y,color,count=16){
      for(let i=0;i<count;i++){
        const a=Math.random()*Math.PI*2, s=(Math.random()*0.5+0.5)*(canvas.height*0.25);
        gs.particles.push({x,y,vx:Math.cos(a)*s,vy:Math.sin(a)*s,life:0,max:0.5+Math.random()*0.5,color});
      }
    }

    // ===== Balloons =====
    function spawnBalloon(){
      const h=canvas.height,w=canvas.width;
      const isRotary = Math.random() < gs.rotaryChance;
      const golden = !isRotary && Math.random() < gs.goldenChance;
      const r = isRotary ? h*0.04 : golden ? h*0.035 : h*(0.022 + Math.random()*0.02);
      const x = Math.random()*(w*0.85 - w*0.1) + w*0.1;
      const vy = -(h*0.06 + Math.random()*h*0.06 + gs.level*0.003*h);
      const hue = golden ? 45 : Math.floor(Math.random()*360);
      gs.balloons.push({x, y:h + r + Math.random()*h*0.2, vy, r, hue, golden, rotary:isRotary, wob:Math.random()*Math.PI*2});
    }

    // ===== Update =====
    function update(dt){
      // time
      const now=performance.now();
      if(now-gs.lastTick>=1000 && running){
        gs.lastTick=now; gs.timeLeft=Math.max(0, gs.timeLeft-1); uiTime.textContent=gs.timeLeft;
        if(gs.timeLeft===0){
          if(gs.level>=5){ running=false; } else{
            gs.level++; uiLevel.textContent=gs.level; gs.timeLeft=60; uiTime.textContent=60; levelChime();
            if(gs.level%3===0){ gs.bonus=true; gs.rotaryChance=0.12; gs.bonusTimer=12; }
          }
        }
      }
      if(gs.bonus){ gs.bonusTimer-=dt; if(gs.bonusTimer<=0){ gs.bonus=false; gs.rotaryChance=0.045; } }

      // parallax
      const base = canvas.width*0.12*dt;
      gs.offsets.clouds=(gs.offsets.clouds+base*0.15)%canvas.width;
      gs.offsets.far=(gs.offsets.far+base*0.35)%canvas.width;
      gs.offsets.mid=(gs.offsets.mid+base*0.6)%canvas.width;
      gs.offsets.track=(gs.offsets.track+base*0.9)%canvas.width;

      // spawn balloons
      const rate = gs.bonus ? 0.028 : (0.012 + gs.level*0.0018);
      if(Math.random() < rate*(dt*60)) spawnBalloon();

      // bullets
      gs.bullets.forEach(b=>{ b.x+=b.vx*dt; b.y+=b.vy*dt; b.life+=dt; });
      gs.bullets = gs.bullets.filter(b=> b.life<1.5 && b.x>-60 && b.x<canvas.width+60 && b.y>-60 && b.y<canvas.height+60);

      // balloons
      gs.balloons.forEach(b=>{ b.wob+=dt*3; b.x += Math.sin(b.wob)*(canvas.width*0.02*dt); b.y += b.vy*dt; });
      gs.balloons = gs.balloons.filter(b=> b.y + b.r > -40);

      // collisions
      for(let i=gs.balloons.length-1;i>=0;i--){
        const bl=gs.balloons[i];
        for(let j=gs.bullets.length-1;j>=0;j--){
          const bu=gs.bullets[j]; const dx=bl.x-bu.x, dy=bl.y-bu.y;
          if(dx*dx+dy*dy < bl.r*bl.r){
            gs.bullets.splice(j,1); gs.balloons.splice(i,1);
            const pts = bl.rotary ? 250 : bl.golden ? 100 : 20;
            gs.score += pts; uiScore.textContent=gs.score;
            popSound(bl.rotary ? 1.15 : bl.golden ? 1.1 : 1);
            const col = bl.rotary ? `hsl(40 95% 50%)` : bl.golden ? `hsl(45 95% 55%)` : `hsl(${bl.hue} 85% 60%)`;
            burst(bl.x, bl.y, col, bl.rotary?30: bl.golden?22:16);
            break;
          }
        }
      }

      // particles
      gs.particles.forEach(p=>{ p.x+=p.vx*dt; p.y+=p.vy*dt; p.vx*=1-1.6*dt; p.vy = p.vy*(1-1.8*dt)+300*dt; p.life+=dt; });
      gs.particles = gs.particles.filter(p=> p.life<p.max);
    }

    // ===== Draw =====
    function draw(){
      const w=canvas.width,h=canvas.height;

      // sky
      const g=ctx.createLinearGradient(0,0,0,h); g.addColorStop(0,'#e5e7eb'); g.addColorStop(1,'#d1d5db');
      ctx.fillStyle=g; ctx.fillRect(0,0,w,h);

      // clouds, trees, ground
      layerRepeat(gs.offsets.clouds,w, x=>drawClouds(x,h*0.16));
      layerRepeat(gs.offsets.far,w, x=>drawTrees(x,h*0.62,h*0.28,0.45));
      layerRepeat(gs.offsets.mid,w, x=>drawTrees(x,h*0.68,h*0.34,0.8));
      ctx.fillStyle=varGet('--ground'); ctx.fillRect(0,h*0.72,w,h*0.28);

      // track
      drawTrack(gs.offsets.track);

      // balloons
      gs.balloons.forEach(b=>{
        if(b.rotary){ drawRotaryBalloon(b.x,b.y,b.r); }
        else drawBalloon(b.x,b.y,b.r, b.golden? 'hsl(45 95% 55%)' : `hsl(${b.hue} 85% 60%)`);
      });

      // train
      drawTrain();

      // bullets
      ctx.fillStyle=varGet('--train-dark');
      gs.bullets.forEach(b=>{ ctx.beginPath(); ctx.arc(b.x,b.y,h*0.006,0,Math.PI*2); ctx.fill(); });

      // particles
      gs.particles.forEach(p=>{
        const a=1-(p.life/p.max); ctx.globalAlpha=a; ctx.fillStyle=p.color; ctx.fillRect(p.x,p.y,h*0.006,h*0.006); ctx.globalAlpha=1;
      });

      // Greenport Express banner
      banner('THE GREENPORT EXPRESS', varGet('--brand-red'));

      // bonus indicator
      if(gs.bonus){ smallBanner(`BONUS WAVE ${Math.ceil(gs.bonusTimer)}s`, '#f59e0b'); }

      // Splash overlay
      if(gs.phase==='splash'){
        overlay(0.65);
        drawSplash();
      }

      // Paused overlay
      if(gs.phase==='playing' && !running){
        overlay(0.45);
        titleText('Paused');
        subText('Press Restart or P to resume');
      }
    }

    // ===== Drawing helpers =====
    function varGet(name){ return getComputedStyle(document.documentElement).getPropertyValue(name).trim(); }
    function layerRepeat(off,w,fn){ fn(-off); fn(w-off); }
    function drawClouds(x,y){
      ctx.fillStyle='rgba(255,255,255,0.92)';
      for(let i=0;i<6;i++){ cloudBlob(x+i*(canvas.width/6), y+Math.sin((i+performance.now()/1000))*10, 80, 3+i%2); }
    }
    function cloudBlob(x,y,r,k=3){ ctx.beginPath(); for(let i=0;i<k;i++){ ctx.arc(x+i*r*0.6,y,r*(0.7+0.2*Math.sin(i)),0,Math.PI*2);} ctx.fill(); }
    function drawTrees(x,baseY,hgt,dens){ for(let i=0;i<Math.floor(12*dens);i++){ const x0=x+i*(canvas.width/12);
        ctx.fillStyle='#7c4a1b'; const tw=canvas.width*0.01, th=hgt*0.42; ctx.fillRect(x0,baseY-th,tw,th);
        ctx.fillStyle='#2e7d32'; ctx.beginPath(); ctx.arc(x0+tw/2, baseY-th, hgt*0.26+(i%2)*hgt*0.08, 0, Math.PI*2); ctx.fill();
      }}
    function drawTrack(off){
      const w=canvas.width,h=canvas.height,y=h*0.78;
      ctx.strokeStyle=varGet('--rail'); ctx.lineWidth=h*0.012;
      ctx.beginPath(); ctx.moveTo(0,y); ctx.lineTo(w,y); ctx.moveTo(0,y+h*0.06); ctx.lineTo(w,y+h*0.06); ctx.stroke();
      const step=w*0.08;
      for(let x=-off; x<w; x+=step){ ctx.fillStyle=varGet('--tie'); ctx.fillRect(x,y-h*0.006,h*0.024,h*0.07); }
    }
    function drawBalloon(x,y,r,color){
      ctx.save(); ctx.fillStyle=color;
      ctx.beginPath(); ctx.ellipse(x,y,r*0.9,r,0,0,Math.PI*2); ctx.fill();
      ctx.fillStyle='rgba(0,0,0,0.15)'; ctx.beginPath(); ctx.moveTo(x,y+r*0.9); ctx.lineTo(x-r*0.12,y+r*1.08); ctx.lineTo(x+r*0.12,y+r*1.08); ctx.closePath(); ctx.fill();
      ctx.globalAlpha=0.25; ctx.fillStyle='#fff'; ctx.beginPath(); ctx.ellipse(x-r*0.3,y-r*0.3,r*0.25,r*0.15,-0.6,0,Math.PI*2); ctx.fill(); ctx.globalAlpha=1;
      ctx.strokeStyle='rgba(0,0,0,0.25)'; ctx.lineWidth=Math.max(1,r*0.06);
      ctx.beginPath(); ctx.moveTo(x,y+r*1.05); ctx.quadraticCurveTo(x+r*0.2, y+r*1.4, x+r*0.05, y+r*1.8); ctx.stroke();
      ctx.restore();
    }
    function drawRotaryBalloon(x,y,r){
      drawBalloon(x,y,r,'hsl(40 95% 55%)');
      drawRotaryCog(x, y, r*0.55, varGet('--train-dark'), varGet('--rotary-gold'));
    }
    function drawRotaryCog(cx,cy,R, stroke='#1f2937', fill='#f59e0b'){
      const teeth=16; const inner=R*0.55, ring=R*0.82;
      ctx.save();
      ctx.fillStyle=fill; ctx.strokeStyle=stroke; ctx.lineWidth=R*0.08;
      ctx.beginPath();
      for(let i=0;i<teeth;i++){
        const a=(i/teeth)*Math.PI*2;
        const a2=a + Math.PI*2/teeth*0.6;
        const r1=ring, r2=R;
        if(i===0) ctx.moveTo(cx+Math.cos(a)*r1, cy+Math.sin(a)*r1);
        ctx.lineTo(cx+Math.cos(a)*r2, cy+Math.sin(a)*r2);
        ctx.lineTo(cx+Math.cos(a2)*r2, cy+Math.sin(a2)*r2);
        ctx.lineTo(cx+Math.cos(a2)*r1, cy+Math.sin(a2)*r1);
      }
      ctx.closePath(); ctx.fill(); ctx.stroke();
      ctx.beginPath(); ctx.arc(cx,cy,inner,0,Math.PI*2); ctx.fillStyle='#fff3cd'; ctx.fill(); ctx.stroke();
      ctx.beginPath(); ctx.arc(cx,cy,inner*0.28,0,Math.PI*2); ctx.fillStyle=fill; ctx.fill();
      ctx.restore();
    }
    function drawTrain(){
      const {x,y,cannonX,cannonY}=trainPos(); const w=canvas.width,h=canvas.height;
      const wheelR=h*0.035;
      const wheelXs=[x+w*0.04, x+w*0.09, x+w*0.14, x+w*0.21];
      wheelXs.forEach(wx=>{
        ctx.fillStyle=varGet('--train-dark'); ctx.beginPath(); ctx.arc(wx,y,wheelR,0,Math.PI*2); ctx.fill();
        ctx.fillStyle='#a3b3c4'; ctx.beginPath(); ctx.arc(wx,y,wheelR*0.45,0,Math.PI*2); ctx.fill();
      });
      // engine body
      ctx.fillStyle=varGet('--train-blue');
      ctx.fillRect(x, y-h*0.14, w*0.18, h*0.11);
      // windows
      ctx.fillStyle='#93c5fd';
      ctx.fillRect(x+w*0.01, y-h*0.13, w*0.05, h*0.06);
      ctx.fillRect(x+w*0.07, y-h*0.13, w*0.05, h*0.06);
      // yellow trim
      ctx.fillStyle=varGet('--train-yellow');
      ctx.fillRect(x- w*0.004, y-h*0.15, w*0.19, h*0.015);
      ctx.fillRect(x- w*0.004, y-h*0.03, w*0.19, h*0.012);
      // boiler
      ctx.fillStyle='#1f2937';
      roundRect(x+w*0.12, y-h*0.18, w*0.11, h*0.09, 12, true);
      // smokestack + puff
      ctx.fillStyle=varGet('--train-dark');
      ctx.fillRect(x+w*0.205, y-h*0.2, w*0.025, h*0.06);
      ctx.fillStyle='rgba(120,144,156,0.4)';
      const puffY = y-h*0.23 - Math.sin(performance.now()/260)*h*0.01;
      ctx.beginPath(); ctx.arc(x+w*0.22, puffY, h*0.025, 0, Math.PI*2); ctx.fill();
      // tender car with label
      ctx.fillStyle=varGet('--train-blue');
      ctx.fillRect(x-w*0.09, y-h*0.10, w*0.12, h*0.08);
      ctx.fillStyle=varGet('--train-yellow');
      ctx.fillRect(x-w*0.092, y-h*0.102, w*0.124, h*0.012);
      ctx.fillRect(x-w*0.092, y-h*0.022, w*0.124, h*0.012);
      ctx.fillStyle='#ffffff';
      ctx.font=`${Math.round(h*0.03)}px/1.1 sans-serif`;
      ctx.textAlign='center'; ctx.textBaseline='middle';
      ctx.fillText('GREENPORT', x-w*0.03, y-h*0.065);
      ctx.fillText('EXPRESS',   x-w*0.03, y-h*0.035);
      // couplers
      ctx.strokeStyle=varGet('--train-dark'); ctx.lineWidth=h*0.006;
      ctx.beginPath(); ctx.moveTo(x-w*0.01, y-h*0.02); ctx.lineTo(x, y-h*0.02); ctx.stroke();
      ctx.beginPath(); ctx.moveTo(x+w*0.18, y-h*0.02); ctx.lineTo(x+w*0.2, y-h*0.02); ctx.stroke();
      // cannon
      const ang=Math.atan2(gs.pointer.y-cannonY, gs.pointer.x-cannonX);
      ctx.save(); ctx.translate(cannonX, cannonY); ctx.rotate(ang);
      ctx.fillStyle=varGet('--train-dark'); ctx.fillRect(0, -h*0.01, w*0.08, h*0.02); ctx.restore();
    }
    function roundRect(x,y,w,h,r,fill=true){
      r=Math.min(r,w/2,h/2); ctx.beginPath();
      ctx.moveTo(x+r,y); ctx.arcTo(x+w,y,x+w,y+h,r); ctx.arcTo(x+w,y+h,x,y+h,r);
      ctx.arcTo(x,y+h,x,y,r); ctx.arcTo(x,y,x+w,y,r); ctx.closePath(); if(fill) ctx.fill(); else ctx.stroke();
    }
    function banner(text, color){
      const w=canvas.width,h=canvas.height; ctx.save();
      ctx.globalAlpha=0.9; ctx.fillStyle=color; const bw=w*0.5,bh=h*0.07;
      ctx.fillRect(w*0.25, h*0.04, bw, bh); ctx.globalAlpha=1;
      ctx.fillStyle='#fff'; ctx.font=`${Math.round(h*0.05)}px/1.1 sans-serif`;
      ctx.textAlign='center'; ctx.textBaseline='middle'; ctx.fillText(text, w*0.5, h*0.075);
      ctx.restore();
    }
    function smallBanner(text, color){
      const w=canvas.width,h=canvas.height; ctx.save();
      ctx.globalAlpha=0.85; ctx.fillStyle=color; ctx.fillRect(w*0.34, h*0.14, w*0.32, h*0.055); ctx.globalAlpha=1;
      ctx.fillStyle='#fff'; ctx.font=`${Math.round(h*0.035)}px/1.1 sans-serif`;
      ctx.textAlign='center'; ctx.textBaseline='middle'; ctx.fillText(text, w*0.5, h*0.167);
      ctx.restore();
    }
    function overlay(a=0.4){ ctx.save(); ctx.fillStyle=`rgba(15,23,42,${a})`; ctx.fillRect(0,0,canvas.width,canvas.height); ctx.restore(); }
    function titleText(t){ ctx.save(); ctx.fillStyle='#fff'; ctx.textAlign='center'; ctx.textBaseline='middle';
      ctx.font=`${Math.round(canvas.height*0.085)}px/1.1 sans-serif`; ctx.fillText(t, canvas.width/2, canvas.height*0.38); ctx.restore(); }
    function subText(t){ ctx.save(); ctx.fillStyle='#e2e8f0'; ctx.textAlign='center'; ctx.textBaseline='middle';
      ctx.font=`${Math.round(canvas.height*0.038)}px/1.2 sans-serif`; ctx.fillText(t, canvas.width/2, canvas.height*0.48); ctx.restore(); }

    function drawSplash(){
      // Title + subtitle lines
      titleText('Joe Cherry Choo Choo');
      ctx.save();
      ctx.fillStyle='#ffffff'; ctx.textAlign='center'; ctx.textBaseline='middle';
      ctx.font=`${Math.round(canvas.height*0.06)}px/1.1 sans-serif`;
      ctx.fillText('â€” The Greenport Express â€”', canvas.width/2, canvas.height*0.46);

      // Credit line
      ctx.fillStyle='#fffbeb';
      ctx.font=`${Math.round(canvas.height*0.04)}px/1.1 sans-serif`;
      ctx.fillText('Made possible by the Rotary Club of Greenport', canvas.width/2, canvas.height*0.55);

      // Start button
      const bw = canvas.width*0.22, bh = canvas.height*0.09;
      const bx = canvas.width/2 - bw/2, by = canvas.height*0.64 - bh/2;
      ctx.fillStyle = '#ef4444'; ctx.globalAlpha=0.92; roundRect(bx,by,bw,bh,18,true); ctx.globalAlpha=1;
      ctx.fillStyle='#ffffff'; ctx.font=`${Math.round(canvas.height*0.05)}px/1.1 sans-serif`;
      ctx.fillText('Start', canvas.width/2, canvas.height*0.64);
      ctx.restore();

      // Hint
      ctx.save();
      ctx.fillStyle='#e2e8f0'; ctx.font=`${Math.round(canvas.height*0.03)}px/1.1 sans-serif`;
      ctx.textAlign='center'; ctx.fillText('Tap or press any key to begin', canvas.width/2, canvas.height*0.74);
      ctx.restore();
    }

    // ===== Main loop =====
    function loop(ts){
      const dt=Math.min(0.033, (ts-lastFrame)/1000); lastFrame=ts;
      if(gs.phase==='playing' && running) update(dt);
      draw();
      requestAnimationFrame(loop);
    }
    requestAnimationFrame(loop);
  </script>
</body>
</html>
