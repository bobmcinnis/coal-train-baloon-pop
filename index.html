https://www.google.com/maps/dir/310+6th+St,+Greenport,+NY+11944-1826,+USA/505+Mt+Beulah+Ave,+Southold,+NY+11971/1750+Mt+Beulah+Ave,+Southold,+NY/@41.085099,-72.4322079,480m/data=!3m1!1e3!4m20!4m19!1m5!1m1!1s0x89e898d1fd2eafbf:0xc59a3a94c1e0fe99!2m2!1d-72.3667918!2d41.0971138!1m5!1m1!1s0x89e89bd739a92711:0x5aaff2ec51af3b4e!2m2!1d-72.430827!2d41.0819391!1m5!1m1!1s0x89e89bd99ca753a9:0x4d11f0ce603d715e!2m2!1d-72.4309463!2d41.0852494!3e0?entry=ttu&g_ep=EgoyMDI1MDgxMy4wIKXMDSoASAFQAw%3D%3D
/* =======================
   TRACKS + VISUAL HELPERS + TRAIN
======================= */
function getVar(name){ return getComputedStyle(document.documentElement).getPropertyValue(name).trim(); }
function overlay(a=0.4){ ctx.save(); ctx.fillStyle=`rgba(15,23,42,${a})`; ctx.fillRect(0,0,canvas.width,canvas.height); ctx.restore(); }
function titleText(t){ ctx.save(); ctx.fillStyle='#fff'; ctx.textAlign='center'; ctx.textBaseline='middle';
  ctx.font=`${Math.round(canvas.height*0.07)}px/1.1 sans-serif`; ctx.fillText(t, canvas.width/2, canvas.height*0.38); ctx.restore(); }
function subText(t){ ctx.save(); ctx.fillStyle='#e2e8f0'; ctx.textAlign='center'; ctx.textBaseline='middle';
  ctx.font=`${Math.round(canvas.height*0.035)}px/1.2 sans-serif`; ctx.fillText(t, canvas.width/2, canvas.height*0.48); ctx.restore(); }
function banner(text, color){
  const w=canvas.width,h=canvas.height; ctx.save();
  ctx.globalAlpha=0.9; ctx.fillStyle=color; const bw=w*0.6,bh=h*0.07;
  ctx.fillRect(w*0.2, h*0.04, bw, bh); ctx.globalAlpha=1;
  ctx.fillStyle='#fff'; ctx.font=`${Math.round(h*0.05)}px/1.1 sans-serif`;
  ctx.textAlign='center'; ctx.textBaseline='middle'; ctx.fillText(text, w/2, h*0.075);
  ctx.restore();
}
function drawSplash(){
  titleText('Joe Cherry Choo Choo');
  ctx.save();
  ctx.fillStyle='#ffffff'; ctx.textAlign='center'; ctx.textBaseline='middle';
  ctx.font=`${Math.round(canvas.height*0.06)}px/1.1 sans-serif`;
  ctx.fillText('â€” The Greenport Express â€”', canvas.width/2, canvas.height*0.46);
  ctx.fillStyle='#fffbeb'; ctx.font=`${Math.round(canvas.height*0.04)}px/1.1 sans-serif`;
  ctx.fillText('Made possible by the Rotary Club of Greenport', canvas.width/2, canvas.height*0.55);
  const bw = canvas.width*0.22, bh = canvas.height*0.09;
  const bx = canvas.width/2 - bw/2, by = canvas.height*0.64 - bh/2;
  ctx.fillStyle = '#ef4444'; ctx.globalAlpha=0.92; roundRect(bx,by,bw,bh,18,true); ctx.globalAlpha=1;
  ctx.fillStyle='#ffffff'; ctx.font=`${Math.round(canvas.height*0.05)}px/1.1 sans-serif`;
  ctx.fillText('Start', canvas.width/2, canvas.height*0.64);
  ctx.fillStyle='#e2e8f0'; ctx.font=`${Math.round(canvas.height*0.03)}px/1.1 sans-serif`;
  ctx.fillText('Tap or press any key to begin (W = whistle)', canvas.width/2, canvas.height*0.74);
  ctx.restore();
}
function drawMilestone(){
  titleText('ðŸŽ‰ Level Up!');
  ctx.save();
  ctx.fillStyle='#ffffff'; ctx.textAlign='center'; ctx.textBaseline='middle';
  ctx.font=`${Math.round(canvas.height*0.055)}px/1.1 sans-serif`;
  ctx.fillText(`Welcome to Level ${gs.level}!`, canvas.width/2, canvas.height*0.46);
  ctx.fillStyle='#e2e8f0'; ctx.font=`${Math.round(canvas.height*0.035)}px/1.1 sans-serif`;
  ctx.fillText('Get ready for more funâ€¦', canvas.width/2, canvas.height*0.54);
  ctx.restore();
}
function roundRect(x,y,w,h,r,fill=true){
  r=Math.min(r,w/2,h/2); ctx.beginPath();
  ctx.moveTo(x+r,y); ctx.arcTo(x+w,y,x+w,y+h,r); ctx.arcTo(x+w,y+h,x,y+h,r);
  ctx.arcTo(x,y+h,x,y,r); ctx.arcTo(x,y,x+w,y,r); ctx.closePath(); if(fill) ctx.fill(); else ctx.stroke();
}

function drawTracks(off){
  const w=canvas.width,h=canvas.height;
  const y=h*0.78;
  ctx.fillStyle='#b59d79'; ctx.fillRect(0, y-h*0.02, w, h*0.12);
  ctx.strokeStyle='#2f2f2f'; ctx.lineWidth=h*0.012;
  ctx.beginPath(); ctx.moveTo(0,y); ctx.lineTo(w,y); ctx.moveTo(0,y+h*0.06); ctx.lineTo(w,y+h*0.06); ctx.stroke();
  const step=w*0.08; let x0 = - (off % step) - step;
  for(let x=x0;x<w+step;x+=step){ ctx.fillStyle='#704a1d'; ctx.fillRect(x,y-h*0.006,h*0.024,h*0.07); }
}

/* (train, balloons, wheels code unchanged â€” keep existing definitions) */

/* =======================
   MAIN LOOP
======================= */
function loop(ts){
  const dt = Math.min(0.033, (ts-lastFrame)/1000); lastFrame=ts;
  if(gs.phase==='playing' && running) update(dt);

  draw();

  // enforce level-up popup stay 3 seconds
  if(gs.phase==='milestone'){
    if(!gs._milestoneStart) gs._milestoneStart=performance.now();
    if(performance.now()-gs._milestoneStart<3000){
      // ignore input
    } else {
      // after 3s allow resume
      canvas.onclick = resumeAfterMilestone;
      window.onkeydown = resumeAfterMilestone;
    }
  }
  requestAnimationFrame(loop);
}
requestAnimationFrame(loop);

/* =======================
   SOUND SWAP FIX
======================= */
// swap usage: jackpot for level-up, level-up for Rotary balloon
function jackpotSound(){ playAudioClone(levelupEl,1); } // <-- now plays level-up.wav
const levelupSound = ()=>playAudioClone(jackpotEl,1);   // <-- now plays jackpot.wav
